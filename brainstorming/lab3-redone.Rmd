---
title: "Red-doing Lab 3"
author: ":)"
date: "`r format(Sys.time(), '%d %B, %Y %H:%M:%OS')`"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
# DO NOT ALTER CODE IN THIS CHUNK
knitr::opts_chunk$set(echo = TRUE, message = FALSE, fig.width=8, fig.height=6, fig.align = 'center')
```


* * *

Complete the following exercises before the submission deadline. In addition to the points detailed below, 5 points are assigned to the quality of the annotation, as well as to the 'cleanliness' of the code and resulting pdf document.

## Exercise 1 -- 1 point

We will again be working with the BC Parks dataset, which contains information on the locations of Provincial Parks in British Columbia. The parks belong to 5 different regions. There is also information on elevation (in m) and percent forest cover contained within the dataset.

* Import the BC park locations dataset and convert the data to a `ppp` object (for today you can exclude information on regions).  -- 1 point(s)

Note: You will need to load the `maptools` package and make use of the `as.owin()` function.

```{r}
# 1
suppressMessages(library(spatstat))
suppressMessages(library(maptools))
load('./BC_Parks.Rda')
parks_ppp = ppp(x = DATA$Parks$X, # X coordinates
                    y = DATA$Parks$Y, # Y coordinates
                    window = as.owin(DATA$Window)) 
```

## Exercise 2 -- 4 points

* Estimate and plot $\rho$ for the locations of parks as a function of both elevation and forest cover (be sure that the x-axis for elevation does not go below 0).  -- 2 point(s)
* Check for collinearity between elevation and forest cover (you will need to consider NA values).  -- 1 point(s)
* Based on these initial analyses, write down the expected form of the model. Provide justification for this starting point.  -- 1 point(s)

Note: Estimating rho can be slow ($\sim$ 1-2 min). Be sure to leave enough time for the document to knit.

```{r, cache=TRUE}
# 1
elev = DATA$Elevation
rho_elev = rhohat(parks_ppp, elev)
forest = DATA$Forest
rho_forest = rhohat(parks_ppp, forest)
par(mfrow = c(1,2))
plot(rho_elev,
     main = "",
     xlab = "Elevation (m)", 
     xlim=c(0, 3600))
plot(rho_forest,
     main = "",
     xlab = "Forest Cover (%)")
par(mfrow = c(1,1))

# 2
cor.im(elev, forest, use = 'complete.obs')
#this correlation is quite weak, so we can continue without worry

# 3
#see below
```

Reasonable model:

\[\lambda_{parks}(u) = e^{\beta_0 + \beta_1 \textrm{elevation(u)} + \beta_2 \textrm{elevation(u)}^2 + \beta_3 \textrm{forest(u)} + \beta_4 \textrm{forest(u)}^2}\]

Both of the elevation and forest coverage rho plots show non-linear relationships. Without getting too complex too fast, having square terms for each variable is a good starting place. It seems as though less parks occur at medium elevations and more at lower elevations; also, more parks occur at medium forest coverage. 


## Exercise 3 -- 4 points

* Fit the model you have defined in exercise 2 and inspect the model output. -- 1 point(s)
* Fit a null, intercept only model.  -- 1 point(s)
* Use AIC and a likelihood ratio test to determine if the model you defined is a better fit than the intercept only model.  -- 1 point(s)
* Write down the equation for the selected model. -- 0.5 point(s)
* Use this equation to estimate the intensity of parks at 500m elevation and 50% forest cover.

```{r}
# 1
fit1 = ppm(parks_ppp ~ elev + I(elev^2) + forest + I(forest^2))
fit1

# 2 
fit2 = ppm(parks_ppp ~ 1)
fit2

# 3
AIC(fit1); AIC(fit2)
AIC(fit2) - AIC(fit1) #delta AIC
anova(fit2, fit1, test = "LRT") #LRT
#the positive delta AIC and the small p-value from the LRT both point 
#to the more complex model being more parsimonious (better fit and 
#worth it)

# 4
#see below

# 5 
exp(-20.72331-0.003934276*500+0.000001391814*500^2+0.04801032*50-0.0004388615*50^2)
```

Model equation:

\[\lambda_{parks}(u) = e^{-20.72-0.00393*\textrm{elevation(u)}+0.00000139*\textrm{elevation(u)}^2+0.048*\textrm{forest(u)}-0.000439*\textrm{forest(u)}^2}\]


## Exercise 4 -- 4 points

* Visualise the fitted model. Note: log scale the estimated intensity when plotting, ignore the standard error. You can use the `n` argument to adjust the resolution  -- 1 point(s)
* Plot the effects of the individual coefficients. Note: use the median value(s) of the other coefficients.  -- 2 point(s)
* Visually, do you think the model predictions are a good match to the data?  -- 1 point(s)

```{r}
# 1
plot(fit1,
     se = FALSE,
     superimpose = FALSE, 
     log = TRUE, n=80)

plot(parks_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = TRUE)
plot(parks_ppp,
     pch = 16,
     cex = 0.5,
     cols = "black",
     add = TRUE)

# 2
elev_effect = effectfun(fit1, "elev", forest = median(forest), se.fit = T)
forest_effect = effectfun(fit1, 'forest', elev = median(elev), se.fit = T)
par(mfrow = c(1,2))
plot(elev_effect,
     legend = FALSE,
     main = "Elevational effect at median \n forest coverage")
plot(forest_effect,
     legend = FALSE,
     main = "Effect of forest coverage at \n median elevation")
par(mfrow = c(1,1))

# 3
```

The model predictions are mediocre. It does alright on the island, but misses a lot of the density on the lower part of BC, and overpredicts in the top right corner. There is definitely room for improvement. 


## Exercise 5 -- 1 point

* Test whether the observed data deviate significantly from the model predictions. -- 1 point(s)

```{r}
# 1
quadrat.test(fit1, nx = 2, ny = 4)
#The small p value tells us that there’s a significant deviation 
#from our model’s predictions.
```


## Exercise 5 -- 2 points

* Calculate and plot the model residuals.  -- 1 point(s)
* Based on the residuals, do you think the model performing well?  -- 1 point(s)

```{r}
# 1
plot(residuals(fit1), cols = "transparent")
```

If the model is performing well, there should be no trend in the residuals. Although it is difficult to tell based on this plot, there is a trend in the residuals. There are larger residuals nearer the coast than there is inland. Perhaps 'distance to the coast' should be included as a covariate to account for this. 


## Exercise 6 -- 3 points

* Calculate the partial residuals as a function of both elevation and forest cover.  -- 1 point(s)
* Do you think that the terms are accurately capturing trends in the data?  -- 1 point(s)
* Do you have enough information to further refine the model and improve it's accuracy?  -- 1 point(s)

```{r}
# 1
par_res_elev = suppressWarnings(parres(fit1, "elev"))
par_res_forest = suppressWarnings(parres(fit1, "forest"))
par(mfrow = c(1,2))
plot(par_res_elev,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Elevation (m)")
plot(par_res_forest,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Forest Coverage (%)")
par(mfrow = c(1,1))

# 2
#The terms actually seem to be doing a pretty good job. However, 
#there are certainly some bumps and curves that are not being modelled. 
#That being said, there is certainly room for improvement. 

# 3
#No, I don't think so. The only thing I could do would be to increase 
#the order of the polynomials, but as mentioned in lab, this is unstable. 
#I think another relevant covariate would be needed in order to improve
#modelling accuracy. 
```


## Exercise 7 -- 1 points

* Based on these analyses, what have you learned about the spatial distribution of parks in BC?  -- 1 point(s)

I have learned that:

* Elevation and forest coverage are both significantly predictive of the number of parks in BC
* The relationship between elevation/forest coverage and \# of parks in BC is non-linear
* elevation and forest coverage in BC are slightly negatively correlated
* other covariates (perhaps 'distance to ocean'?) are needed in order to further improve model accuracy 
